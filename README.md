# Docker OpenXPKI

[OpenXPKI][] certificate management in a Docker container.


## Usage
```
docker run -p 8443:443 -v <volume>:/etc/openxpki -e <ENV> moonbuggy2000/openxpki:latest
```

On first run the container will create and initialize a database as specified by the environment (see below), then import an OpenXPKI configuration either from a user-provided _customconfig.sh_ or, failing that, the _defaultconfig.sh_ from this repo. The server should then be accessible via HTTPS.

## Configuration
A realm and the database can be configured through the container environment or in the normal `/etc/openxpki/` configuration files. In the latter case, and for any configuration beyond what is described here, refer to the [OpenXPKI docs][oxpki-docs].

Note: Although this image can do much of the [OpenXPKI Quickstart][oxpki-quickstart] process on its own with minimal configuration, it may not be the sort of thing you want done automatically. This image will provide an easy PKI, not necessarily a production-ready PKI.

### Container Environment
There are few types of environment variables:
*   __OXPKI\_DB\_\*__ - processed at every startup and will take precedence over (and, in fact, overwrite) any configuration in `database.yaml` if set, on-disk configuration will be used if unset
*   __OXPKI\_DB\_ROOT\_\*__ - as above but only required if a database needs to be created, and can't be configured in `database.yaml`, must be via the environment
*   __OXPKI\_SETUP\_\*__  - only processed during container initialization (typically at first run) by _defaultconfig.sh_ and _do not_ take precedence over any existing realm configuration files

Valid environment variables are:

*   ``OXPKI_DB_TYPE``				   	- database type (accepts: `mariadb` (default), `mysql`, `postgresql`)
*   ``OXPKI_DB_NAME``					  - database name (default: `openxpki`)
*   ``OXPKI_DB_HOST``				  	- database host name or IP
*   ``OXPKI_DB_PORT``			  		- database port (default: `3306`)
*   ``OXPKI_DB_USER``			  		- database user name (default: `openxpki`)
*   ``OXPKI_DB_PASS``			  		- database user password (default: `openxpki`)
*   ``OXPKI_DB_ROOT_USER``  		- database `root` user
*   ``OXPKI_DB_ROOT_PASS``	  	- database `root` password
*   ``OXPKI_DB_MAX_RETRIES``  	- database connection attempt limit (default: `30`)
*   ``OXPKI_DB_SSLMODE``        - PostgreSQL [SSL mode](https://www.postgresql.org/docs/11/libpq-ssl.html#LIBPQ-SSL-SSLMODE-STATEMENTS) (default: `disable`)
*   ``OXPKI_SETUP_REALM``       - a realm to configure from _defaultconfig.sh_ (default: `democa`)
*   ``OXPKI_SETUP_CA_DIR``      - a folder to store cert, key and pass files generated by _defaultconfig.sh_ (default: `/etc/openxpki/config.d/realm/${REALM}/ca`)
*   ``OXPKI_SETUP_KEY_PASS``    - set to a password to use for all generated keys, unset for random key generation (default: unset)
*   ``OXPKI_SETUP_RAOP_NAME``   - RA Operator user name (default: `raop`)
*   ``OXPKI_SETUP_RAOP_PASS``   - RA Operator password (default: `openxpki`)
*   ``OXPKI_SETUP_FQDN``        - server FQDN for certificates (default: container's hostname)
*   ``OXPKI_SETUP_ROOT_CA_SUBJECT``     - subject for generated root CA (default: `/CN=${REALM} Root CA`)
*   ``OXPKI_SETUP_ISSUING_CA_SUBJECT``  - subject for generated issuing CA (default: `/O=${REALM}/OU=PKI/CN=${REALM} Issuing CA`)
*   ``OXPKI_DEBUG``					  	- set the `--debug` argument on `openxpkictl`, see the [openxpkictl manpage][oxpki-manpage] for details on appropriate values (default: unset)

## Initialization
Initialization occurs via execution of either a user-provided _customconfig.sh_, or the included `/etc/openxpki/defaultconfig.sh` script. This occurs when the file `/etc/openxpki/.initiated` is _not_ found, which usually only happens on a container's first run (if `/etc/openxpki` is persistent). If you already have a configuration you want to keep then make sure this file is present before starting the container.

A re-initialization on next start can be forced by touching the file `/etc/openxpki/.force_init`, which is useful if _defaultconfig.sh_ is applied on first run and you later wish to apply your own _customconfig.sh_, or to re-run _defaultconfig.sh_ if you're playing with container environment variables.

You probably have to delete a realm's folder to successfully re-run an initialization of that realm, _defaultconfig.sh_ will not modify any existing configuration it finds, in most cases. For a clean outcome the database may need to be dropped as well, but this can be skipped if you're testing and don't mind some non-fatal errors in the webUI.

### customconfig.sh
Any _customconfig.sh_ file should be placed at either `/import/customconfig.sh` or `/etc/openxpki/customconfig.sh`. If found, it will be run during initialization in preference to the _defaultconfig.sh_ in the image.

### defaultconfig.sh
The _defaultconfig.sh_ script works much the same as the default OpenXPKI [_sampleconfig.sh_][oxpki-sampleconfig] script in the [OpenXPKI config repo][oxpki-config] it is based on, with the following differences:

*   allow a realm to be specified via the _OXPKI\_SETUP\_REALM_ environment variable
*   import user-provided certificates from a volume at `/import`, or generate automatically if not provided
*   allow generation of certificates with random key passwords (pass files are stored in _OXPKI\_SETUP\_CA\_DIR_)
*   install with a single Operator account (no test accounts), optionally configured from the environment (using _OXPKI\_SETUP\_RAOP\_\*_)

Further manual configuration will be likely be required, but this should cover much of the [OpenXPKI Quickstart][oxpki-quickstart] using just the container environment and a mounted volume to import certificates.

#### Certificates
A volume mounted at `/import` will be checked by _defaultconfig.sh_ and relevant certificate files, if found, will be copied to the realm's _OXPKI\_SETUP\_CA\_DIR_ and used to initialize the realm. Any required certificates not provided as files will be generated automatically, with passwords governed by _OXPKI\_SETUP\_KEY\_PASS_.

Relevant files are certificate, request, key and password files, named as follows:

*   _OpenXPKI\_DataVault.(crt|csr|key|pass)_
*   _OpenXPKI\_Issuing_CA.(crt|csr|key|pass)_
*   _OpenXPKI\_Root_CA.(crt|csr|key|pass)_
*   _OpenXPKI\_SCEP_RA.(crt|csr|key|pass)_
*   _OpenXPKI\_WebUI.(crt|csr|key|pass)_

Files will be ignored when they don't make sense. If a certificate depends on another that was automatically generated then it can't be imported from a file, it needs to be generated and signed appropriately. This means, if you are providing some of these files, the Root CA will very likely need to be among them, as will the Issuing CA if you're providing SCEP RA and WebUI files.

The `/import` folder is only checked during initialization and the mount can be safely removed once _defaultconfig.sh_ has copied the files to _OXPKI\_SETUP\_CA\_DIR_.


## Links
GitHub: <https://github.com/moonbuggy/docker-openxpki>

Docker Hub: <https://hub.docker.com/r/moonbuggy2000/openxpki>

usql-static: <https://github.com/moonbuggy/usql-static>


[OpenXPKI]: https://www.openxpki.org/ (OpenXPKI)
[oxpki-docs]: http://openxpki.readthedocs.io/en/latest/ (OpenXPKI manual)
[oxpki-quickstart]: https://openxpki.readthedocs.io/en/latest/quickstart.html (OpenXPKI quickstart)
[oxpki-config]: https://github.com/openxpki/openxpki-config/ (openxpki-config)
[oxpki-sampleconfig]: https://github.com/openxpki/openxpki-config/blob/community/contrib/sampleconfig.sh (sampleconfig.sh)
[oxpki-manpage]: https://manned.org/openxpkictl/f9b633c3
